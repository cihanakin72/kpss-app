<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KPSS Koçum Pro</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e2e">
    
    <!-- Cropper CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <!-- Chart.js & Cropper JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e2e;
            --primary: #6366f1;
            --secondary: #06b6d4;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #2d2d42;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: var(--bg-body); color: var(--text-main); 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            position: fixed; width: 100%;
        }

        /* CROPPER MODAL */
        .cropper-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 99999;
            display: none; flex-direction: column;
        }
        .cropper-area { flex: 1; position: relative; overflow: hidden; background: #000; }
        .cropper-controls {
            height: 80px; background: #1e1e2e; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-top: 1px solid var(--border);
        }
        .crop-btn { padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; }
        .btn-cancel { background: #333; color: white; }
        .btn-confirm { background: var(--primary); color: white; }

        /* ALT MENÜ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 12px 5px;
            z-index: 1000; padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .nav-btn { background: none; border: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; gap: 4px; cursor: pointer; flex: 1; }
        .nav-btn i { font-size: 1.3rem; margin-bottom: 2px; }
        .nav-btn.active { color: var(--primary); font-weight: bold; }

        /* ANA İÇERİK */
        .main-content { flex: 1; overflow-y: auto; padding: 15px 15px 90px 15px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        h2 { font-size: 1.3rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-top: 0; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* GERİ SAYIM KARTI */
        .countdown-card {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d42 100%);
            border: 1px solid var(--warning); border-radius: 12px;
            padding: 15px; margin-bottom: 20px; text-align: center; position: relative;
        }
        .count-days { font-size: 2.5rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-top: 40px; }
        .count-label { font-size: 0.9rem; color: var(--warning); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; font-weight: 600; }
        
        #exam-selector {
            position: absolute; top: 10px; right: 10px; left: 10px; width: calc(100% - 20px);
            background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            padding: 8px; border-radius: 8px; font-size: 0.9rem;
            outline: none; cursor: pointer; text-align: center;
            -webkit-appearance: none; appearance: none; font-weight: bold;
        }
        #exam-selector option { background: #1e1e2e; color: #fff; }

        /* GELİŞTİRİCİ KARTI (ESKİ HALİNE DÖNDÜ) */
        .dev-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(6, 182, 212, 0.1) 100%);
            border: 1px solid var(--primary);
            border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
        }
        .app-title { font-size: 1.2rem; font-weight: 800; color: #fff; margin-bottom: 5px; letter-spacing: 1px; }
        .dev-name { font-size: 0.9rem; color: #a5b4fc; margin-bottom: 10px; }
        .contact-info { font-size: 0.8rem; color: #cbd5e1; display: flex; justify-content: center; gap: 15px; }
        .contact-info i { margin-right: 5px; }

        /* KARTLAR */
        .card { background: var(--bg-card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        
        /* DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .stat-box:active { transform: scale(0.96); background: rgba(255,255,255,0.06); }
        .stat-val { font-size: 1.4rem; font-weight: bold; margin-top: 5px; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

        /* FORM */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; background: #151520; border: 1px solid var(--border); color: white; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; }

        /* DERS SATIRLARI */
        .lesson-row { display: grid; grid-template-columns: 3fr 1fr 1fr 1.5fr; gap: 10px; align-items: center; background: rgba(255,255,255,0.02); padding: 12px; margin-bottom: 8px; border-radius: 8px; }
        .lesson-row div:first-child { font-size: 0.9rem; font-weight: 500; }
        .lesson-row input { text-align: center; padding: 8px 0; background: #111; border: 1px solid #333; }
        .net-badge { font-size: 0.9rem; color: var(--secondary); font-weight: bold; text-align: right; background: rgba(6, 182, 212, 0.1); padding: 5px; border-radius: 4px; }

        /* AKORDİYON */
        .accordion { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; background: var(--bg-card); overflow: hidden; }
        .accordion-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); cursor: pointer; }
        .accordion-content { display: none; padding: 10px; border-top: 1px solid var(--border); background: #15151e; }
        .accordion-content.open { display: block; }
        .topic-item { display: flex; align-items: center; padding: 12px 5px; border-bottom: 1px solid #222; }
        .custom-cb { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--success); }
        .topic-name { flex: 1; font-size: 0.9rem; }
        .section-title { font-size: 0.75rem; color: var(--warning); margin: 15px 0 5px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* HAVUZ TAB */
        .tab-menu { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-item { flex: 1; padding: 10px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; cursor: pointer; text-align: center; }
        .tab-item.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* HAVUZ KARTLARI */
        .q-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .q-header { padding: 15px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .q-tag { font-size: 0.8rem; color: var(--secondary); font-weight: bold; }
        .q-body { padding: 15px; }
        .q-text { font-size: 1rem; margin-bottom: 15px; line-height: 1.5; }
        .q-img-box { width: 100%; margin-bottom: 15px; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
        .q-img-box img { width: 100%; display: block; }
        
        .q-answer-section { margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border); display: none; animation: fadeIn 0.3s; }
        .q-answer-section.visible { display: block; }
        .q-answer-title { color: var(--success); font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; }
        .cahil-msg { font-size: 0.8rem; color: var(--warning); font-style: italic; margin-bottom: 10px; }

        .q-reveal-btn { width: 100%; padding: 12px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; cursor: pointer; margin-top:10px;}
        .q-reveal-btn:hover { background: #444; }

        /* RESİM ALANLARI */
        .upload-area { border: 2px dashed var(--border); padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 15px; cursor: pointer; position: relative; }
        .upload-area p { margin: 5px 0 0 0; font-size: 0.8rem; color: var(--text-muted); }
        .upload-area.filled { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        .preview-thumb { max-height: 100px; margin-top: 10px; border-radius: 5px; display: none; }

        /* ŞIK SEÇİMİ */
        .opt-group { display: flex; justify-content: center; gap: 5px; margin: 15px 0; flex-wrap: wrap; }
        .opt-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .opt-wide { width: auto; padding: 0 15px; border-radius: 20px; }
        .radio-label input { display: none; }
        .radio-label input:checked + .opt-btn { background: var(--success); border-color: var(--success); color: black; }
        .opt-btn.correct { background: var(--success); border-color: var(--success); color: black; }
        .opt-btn.wrong { background: var(--danger); border-color: var(--danger); color: white; }

        /* SİLME BUTONU */
        .delete-btn { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }

        /* Veri Yönetimi */
        .data-tools { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-data { flex: 1; padding: 10px; border-radius: 8px; font-size: 0.85rem; border: none; cursor: pointer; font-weight: bold; }
        .btn-backup { background: #151520; border: 1px solid var(--primary); color: var(--primary); }
        .btn-restore { background: #151520; border: 1px solid var(--secondary); color: var(--secondary); }
        .btn-reset { background: #151520; border: 1px solid var(--danger); color: var(--danger); }

        .hidden { display: none; }
        .canvas-box { height: 250px; margin-bottom: 20px; position: relative; }
        .history-chart-container { min-height: 300px; height: 300px; margin-bottom: 20px; width: 100%; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

</head>
<body>

    <!-- CROPPER MODAL -->
    <div id="cropper-modal" class="cropper-modal-overlay">
        <div class="cropper-area">
            <img id="cropper-img" style="max-width:100%; max-height:80vh;">
        </div>
        <div class="cropper-controls">
            <button class="crop-btn btn-cancel" onclick="cancelCrop()">İptal</button>
            <button class="crop-btn btn-confirm" onclick="performCrop()">Kırp & Kaydet</button>
        </div>
    </div>

    <div class="main-content">
        
        <!-- DASHBOARD -->
        <div id="page-dashboard">
            <div class="dev-card">
                <div class="app-title">KPSS Takip Pro</div>
                <div class="dev-name">Geliştirici: Cihan Akın</div>
                <div class="contact-info">
                    <span><i class="fas fa-envelope"></i> cihanakin72@outlook.com</span>
                    <span><i class="fab fa-instagram"></i> cihan.akin7</span>
                </div>
            </div>

            <div class="countdown-card">
                <select id="exam-selector" onchange="updateExamSelection()">
                    <option value="">Hedef Sınavını Seçiniz</option>
                    <option value="2026-09-06">KPSS Lisans (06.09.2026)</option>
                    <option value="2026-10-04">KPSS Önlisans (04.10.2026)</option>
                    <option value="2026-10-25">KPSS Ortaöğretim (25.10.2026)</option>
                </select>
                <div class="count-days" id="count-val">0</div>
                <div class="count-label" id="count-lbl">Sınava Kalan Gün</div>
            </div>

            <h2>Genel Durum</h2>
            <div class="stats-grid">
                <div class="stat-box" onclick="nav('history', document.getElementById('btn-hist'))">
                    <div class="stat-val" id="d-total">0</div>
                    <div class="stat-label">Toplam Deneme</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" style="color:var(--secondary)" id="d-avg">0.0</div>
                    <div class="stat-label">Ortalama Net</div>
                </div>
                <div class="stat-box" onclick="nav('pool', document.getElementById('btn-pool'))">
                    <div class="stat-val" style="color:var(--warning)" id="d-pool">0</div>
                    <div class="stat-label">Soru Havuzuna Git</div>
                </div>
                <div class="stat-box" onclick="nav('topics', document.getElementById('btn-top'))">
                    <div class="stat-val" style="color:var(--primary)" id="d-prog">%0</div>
                    <div class="stat-label">Konu Bitirme</div>
                </div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; font-size:1rem; display:flex; justify-content:space-between;">
                    Net Gidişatı
                    <span id="target-lbl" onclick="setTargetNet()" style="font-size:0.8rem; color:var(--danger); cursor:pointer;">Hedef: 85 <i class="fas fa-edit"></i></span>
                </h3>
                <div class="canvas-box"><canvas id="lineChart"></canvas></div>
            </div>
        </div>

        <!-- DENEME EKLEME -->
        <div id="page-add" class="hidden">
            <h2>Deneme Ekle</h2>
            <div class="card">
                <div class="input-group">
                    <label>Deneme Adı</label>
                    <input type="text" id="inp-name" placeholder="Örn: Pegem TG-1">
                </div>
                <div class="input-group">
                    <label>Tarih</label>
                    <input type="date" id="inp-date">
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; padding:0 10px; font-size:0.8rem; color:#888; margin-bottom:5px;">
                <span style="flex:3">Ders</span><span style="flex:1; text-align:center">D</span><span style="flex:1; text-align:center">Y</span><span style="flex:1.5; text-align:right">Net</span>
            </div>
            <div id="lessons-container"></div>
            <button class="btn-primary" onclick="saveExam()">KAYDET</button>
        </div>

        <!-- SORU HAVUZU -->
        <div id="page-pool" class="hidden">
            <h2>Soru Havuzu</h2>
            <div class="tab-menu">
                <button class="tab-item active" onclick="poolTab('add')">Soru Ekle</button>
                <button class="tab-item" onclick="poolTab('list')">Soruları Gör</button>
            </div>

            <!-- EKLEME -->
            <div id="pool-add-view">
                <div class="input-group"><select id="pool-lesson" onchange="loadPoolTopics()"></select></div>
                <div class="input-group"><select id="pool-topic"><option value="">Konu Seç...</option></select></div>
                
                <!-- SORU -->
                <div class="card">
                    <h3 style="margin-top:0; font-size:0.9rem; color:var(--text-muted);">SORU</h3>
                    <div class="upload-area" onclick="triggerFile('file-q')" id="ua-q">
                        <i class="fas fa-camera"></i>
                        <p>Soru Resmi Ekle (Kırpılabilir)</p>
                        <input type="file" id="file-q" accept="image/*" hidden onchange="handleCropImage(this, 'poolQ')">
                        <img id="prev-q" class="preview-thumb">
                    </div>
                    <div class="input-group">
                        <textarea id="text-q" rows="3" placeholder="Veya buraya soruyu yaz..."></textarea>
                    </div>
                </div>

                <!-- DOĞRU ŞIK -->
                <div class="card" style="text-align:center;">
                    <h3 style="margin-top:0; font-size:0.9rem; color:var(--warning);">DOĞRU ŞIKKI SEÇİN</h3>
                    <div class="opt-group">
                        <label class="radio-label"><input type="radio" name="correct" value="A"><span class="opt-btn">A</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="B"><span class="opt-btn">B</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="C"><span class="opt-btn">C</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="D"><span class="opt-btn">D</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="E"><span class="opt-btn">E</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="NONE"><span class="opt-btn opt-wide">Şık Yok (Klasik)</span></label>
                    </div>
                </div>

                <!-- CEVAP -->
                <div class="card">
                    <h3 style="margin-top:0; font-size:0.9rem; color:var(--text-muted);">CEVAP / ÇÖZÜM DETAYI</h3>
                    <div class="upload-area" onclick="triggerFile('file-a')" id="ua-a">
                        <i class="fas fa-lightbulb"></i>
                        <p>Çözüm Resmi Ekle (Kırpılabilir)</p>
                        <input type="file" id="file-a" accept="image/*" hidden onchange="handleCropImage(this, 'poolA')">
                        <img id="prev-a" class="preview-thumb">
                    </div>
                    <div class="input-group">
                        <textarea id="text-a" rows="3" placeholder="Veya cevabı buraya yaz..."></textarea>
                    </div>
                </div>

                <button class="btn-primary" onclick="addToPool()">HAVUZA KAYDET</button>
            </div>

            <!-- LİSTELEME & ÇÖZME -->
            <div id="pool-list-view" class="hidden">
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <select id="list-l-filter" onchange="renderPoolList()"><option value="all">Tüm Dersler</option></select>
                    <select id="list-t-filter" onchange="renderPoolList()"><option value="all">Tüm Konular</option></select>
                </div>
                <div id="pool-list-container"></div>
            </div>
        </div>

        <!-- KONU TAKİBİ -->
        <div id="page-topics" class="hidden">
            <h2>Konu Takibi</h2>
            <div id="topics-list"></div>
        </div>

        <!-- GEÇMİŞ -->
        <div id="page-history" class="hidden">
            <h2>Geçmiş & Yedek</h2>
            <div class="data-tools">
                <button class="btn-data btn-backup" onclick="exportData()"><i class="fas fa-download"></i> Yedekle</button>
                <button class="btn-data btn-restore" onclick="triggerImport()"><i class="fas fa-upload"></i> Yükle</button>
                <button class="btn-data btn-reset" onclick="clearData()"><i class="fas fa-trash"></i> Sıfırla</button>
                <input type="file" id="import-file" accept=".json" hidden onchange="importData(this)">
            </div>
            <div class="card">
                <h3 style="margin-top:0; font-size:1rem;">Ders Bazlı Gelişim</h3>
                <div class="history-chart-container"><canvas id="historyChart"></canvas></div>
            </div>
            <div id="history-list"></div>
        </div>

    </div>

    <!-- ALT MENÜ -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="nav('dashboard', this)"><i class="fas fa-chart-pie"></i><span>Özet</span></button>
        <button class="nav-btn" onclick="nav('add', this)"><i class="fas fa-plus-circle"></i><span>Ekle</span></button>
        <button class="nav-btn" id="btn-pool" onclick="nav('pool', this)"><i class="fas fa-camera"></i><span>Havuz</span></button>
        <button class="nav-btn" id="btn-top" onclick="nav('topics', this)"><i class="fas fa-tasks"></i><span>Konu</span></button>
        <button class="nav-btn" id="btn-hist" onclick="nav('history', this)"><i class="fas fa-history"></i><span>Geçmiş</span></button>
    </div>

<script>
    const LESSONS = [{k:'tr', l:'Türkçe', q:30}, {k:'mat', l:'Matematik', q:30}, {k:'tar', l:'Tarih', q:27}, {k:'cog', l:'Coğrafya', q:18}, {k:'vat', l:'Vatandaşlık', q:15}];
    const TOPICS = {
        'Türkçe': ['Ses Bilgisi', 'Yazım Kuralları', 'Noktalama İşaretleri', 'Sözcükte Yapı', 'Cümlenin Ögeleri', 'Anlatım Bozukluğu', 'Sözel Mantık', '--- SÖZCÜK TÜRLERİ ---', '1-İsimler', '2-Tamlamalar', '3-Zamirler ( Adıl )', '4-Sıfat (Ön ad)', '5-Zarf ( Belirteç )', '6-Edat / Bağlaç', 'SÖZCÜKTE ANLAM', '--- CÜMLEDE ANLAM ---', '1-Cümle Tamamlama', '2-Cümle Oluşturma', '3-Cümle Yorumu', '4-Cümlelerin Anlam Özelliği', '5-Cümlede Kesin Yargı', '6- Cümle Birleştirme', '--- PARAGRAFTA ANLAM ---', '1-Anlatım biçimleri', '2-Konu başlık bulma', '3-Ana düşünce', '4-Yardımcı düşünce', '5-Akışı bozan cümle', '6-Tamamlama', '7-Cümle ekleme', '8-İkiye bölme', '9-Yer değiştirme', '10-Paragraf oluşturma', '11-Çoklu sorular'],
        'Matematik': ['Temel Kavramlar', 'Sayı Basamakları', 'Bölme / Bölünebilme', 'Rasyonel Sayılar', 'Eşitsizlikler', 'Mutlak Değer', 'Üslü Sayılar', 'Köklü Sayılar', 'Çarpanlara Ayırma', 'Oran-Orantı', 'Kümeler', 'İşlem ve Modüler aritmetik', 'Fonksiyon', 'Per/Kom/Olasılık', 'Sayısal Mantık', '--- PROBLEMLER ---', 'Sayı', 'Kesir', 'Yaş', 'Hareket', 'İşçi havuz', 'Kar-Zarar', 'Karışım', 'Grafik', '--- GEOMETRİ ---', 'Üçgenler', 'Çokgenler / Dörtgenler', 'Çember ve Daire', 'Analitik Geometri', 'Katı Cisimler'],
        'Tarih': ['İslamiyet Öncesi ilk T.T', 'İlk Türk-İslam Devletleri', 'Anadolu Selçuklu Devleti', '--- OSMANLI DEVLETİ ---', 'Kültür ve Medeniyeti', 'Kuruluş Dönemi', 'Yükselme Dönemi', 'Duraklama Dönemi - XVII. yy', 'Gerileme Dönemi - XVIII. yy', 'Dağılma Dönemi - XIX. yy', '--- İNKLAP TARİHİ ---', 'XX. Yüzyılda Osmanlı Devleti', 'Kurtuluş Savaşı Hazırlık Dönemi', 'I. TBMM Dönemi ve Ayaklanmalar', 'Kurtuluş Savaşı Dönemi', 'Atatürk\'ün Hayatı', 'Atatürk Dönemi İç Politika', 'Atatürk İlkeleri', 'Atatürk İnklapları', 'Atatürk Dönemi Dış Politika', '--- ÇAĞDAŞ TÜRK VE DÜNYA TARİHİ ---', 'XX. yy Başlarında Dünya', 'II. Dünya Savaşı', 'Soğuk Savaş Dönemi', 'Yumuşama Dönemi', 'Küreselleşen Dünya'],
        'Coğrafya': ['Türkiye\'nin Coğrafi Konumu', 'Türkiye\'nin İklimi', '--- TÜRKİYENİN YER ŞEKİLLERİ ---', '1-Dağlar', '2-Akarsular', '3-Platolar', '4-Ovalar', '5-Gölleri', '6-Göl ve Barajları', '7-Doğal Afetler', '8-Toprak Oluşumu ve Çeşitleri', '9-Dış Kuvvetler', '--- TÜRKİYE\'NİN BEŞERİ VE EKONOMİ COĞRAFYASI ---', '1-NÜFÜS', '2-TARIM', '3-HAYVANCILIK', '4-MADENLER', '5-MADEN VE ENERJİ KAYNAKLARI', '6-SANAYİ', '7-ULAŞIM', '8-TİCARET', '9-TURİZM', '10-BÖLGESEL KALKINMA PROJELERİ'],
        'Vatandaşlık': ['Temel Hukuk Kavramları', 'Anayasa Tarihi', '1982 Anayasası Genel Hükümler', 'Temel Hak ve Hürriyetler', 'Yasama', 'Yürütme', 'Yargı', 'İdare Hukuku', 'İnsan Hakları']
    };

    let db = JSON.parse(localStorage.getItem('kpss_pro_v30')) || {exams:[], topics:{}, pool:[], config:{target:85, examDate:''}};
    let chartInst = {};
    let imgB64PoolQ = '', imgB64PoolA = '';
    let cropper = null;
    let currentCropTarget = '';

    window.onload = () => { 
        document.getElementById('inp-date').valueAsDate = new Date(); 
        if(db.pool) db.pool.forEach(x => { if(!x.id) x.id = Date.now() + Math.random(); });
        save();
        initUI(); updateStats(); updateCountdown(); 
    };

    function initUI() {
        document.getElementById('lessons-container').innerHTML = LESSONS.map(L => `<div class="lesson-row"><div>${L.l}</div><input type="number" inputmode="numeric" id="d-${L.k}" placeholder="0" min="0" onblur="calcNet('${L.k}',${L.q}, 'd')"><input type="number" inputmode="numeric" id="y-${L.k}" placeholder="0" min="0" onblur="calcNet('${L.k}',${L.q}, 'y')"><div class="net-badge" id="n-${L.k}">0.0</div></div>`).join('');
        
        document.getElementById('topics-list').innerHTML = Object.keys(TOPICS).map((sub, i) => { 
            const list = TOPICS[sub], realT = list.filter(t => !t.trim().startsWith('-') && !t.trim().startsWith('—')), done = realT.filter(t => db.topics[`${sub}-${t}`]).length, pct = Math.round((done/realT.length)*100); 
            return `<div class="accordion"><div class="accordion-header" onclick="toggleAcc(this)"><div><strong>${sub}</strong></div><div id="pct-${i}" style="font-size:0.8rem; color:${pct===100?'var(--success)':'#aaa'}">%${pct}</div></div><div class="accordion-content">${list.map(t => (t.startsWith('---') || t.startsWith('—')) ? `<div class="section-title">${t.replace(/-/g,'').replace(/—/g,'')}</div>` : `<div class="topic-item" onclick="toggleTop('${sub}-${t}','${sub}',${i},this)"><input type="checkbox" class="custom-cb" ${db.topics[`${sub}-${t}`]?'checked':''}><span class="topic-name">${t}</span></div>`).join('')}</div></div>`; 
        }).join('');
        
        const opts = LESSONS.map(l=>`<option value="${l.l}">${l.l}</option>`).join('');
        const poolLessonSel = document.getElementById('pool-lesson');
        poolLessonSel.innerHTML += opts; poolLessonSel.value = "Türkçe"; loadPoolTopics();
        document.getElementById('list-l-filter').innerHTML += opts;
        
        if(db.config.examDate) {
            const sel = document.getElementById('exam-selector');
            if([...sel.options].some(o => o.value === db.config.examDate)) sel.value = db.config.examDate;
        }
        document.getElementById('target-lbl').innerHTML = `Hedef: ${db.config.target || 85} <i class="fas fa-edit"></i>`;
    }

    window.nav = (page, btn) => {
        document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`page-${page}`).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(page==='dashboard') updateStats();
        if(page==='history') { renderHistory(); renderHistoryChart(); }
        if(page==='pool') poolTab('list');
    };

    // --- HAVUZ ---
    window.poolTab = (m) => { 
        document.querySelectorAll('#page-pool .hidden').forEach(e=>e.classList.add('hidden')); 
        document.getElementById(`pool-${m}-view`).classList.remove('hidden'); 
        if(m==='list') renderPoolList(); 
    };
    window.loadPoolTopics = () => { let l=document.getElementById('pool-lesson').value, s=document.getElementById('pool-topic'); s.innerHTML='<option value="">Konu Seç...</option>'; if(TOPICS[l]) TOPICS[l].forEach(t=>{if(!t.startsWith('-') && !t.startsWith('—'))s.innerHTML+=`<option>${t}</option>`}); };
    
    window.triggerFile = (id) => document.getElementById(id).click();

    window.handleCropImage = (inp, targetVar) => {
        if (inp.files && inp.files[0]) {
            const file = inp.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('cropper-img');
                img.src = e.target.result;
                document.getElementById('cropper-modal').style.display = 'flex';
                currentCropTarget = targetVar;
                if (cropper) cropper.destroy();
                cropper = new Cropper(img, { viewMode: 1, autoCropArea: 1 });
                inp.value = ''; 
            };
            reader.readAsDataURL(file);
        }
    };

    window.cancelCrop = () => {
        document.getElementById('cropper-modal').style.display = 'none';
        if(cropper) cropper.destroy();
    };

    window.performCrop = () => {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({ maxWidth: 800 });
        const b64 = canvas.toDataURL('image/jpeg', 0.7);
        
        if (currentCropTarget === 'poolQ') {
            imgB64PoolQ = b64;
            document.getElementById('prev-q').src = b64;
            document.getElementById('prev-q').style.display = 'block';
            document.getElementById('ua-q').classList.add('filled');
        } else if (currentCropTarget === 'poolA') {
            imgB64PoolA = b64;
            document.getElementById('prev-a').src = b64;
            document.getElementById('prev-a').style.display = 'block';
            document.getElementById('ua-a').classList.add('filled');
        }
        cancelCrop();
    };

    window.addToPool = () => {
        let qTxt = document.getElementById('text-q').value;
        let aTxt = document.getElementById('text-a').value;
        let correctOpt = document.querySelector('input[name="correct"]:checked')?.value;
        
        if(!qTxt && !imgB64PoolQ) return alert('Soru için en az bir resim veya yazı girin.');
        if(!aTxt && !imgB64PoolA) return alert('Cevap/Çözüm için en az bir resim veya yazı girin.');
        if(!correctOpt) return alert('Doğru şıkkı seçmelisiniz (Şık yoksa "Şık Yok"u seçin).');

        db.pool.push({
            id: Date.now(),
            l: document.getElementById('pool-lesson').value,
            t: document.getElementById('pool-topic').value,
            qTxt: qTxt, qImg: imgB64PoolQ,
            aTxt: aTxt, aImg: imgB64PoolA,
            correct: correctOpt
        });
        save(); alert('Eklendi!');
        
        imgB64PoolQ=''; imgB64PoolA='';
        document.getElementById('text-q').value=''; document.getElementById('text-a').value='';
        document.getElementById('prev-q').style.display='none'; document.getElementById('prev-a').style.display='none';
        document.getElementById('ua-q').classList.remove('filled'); document.getElementById('ua-a').classList.remove('filled');
        document.querySelectorAll('input[name="correct"]').forEach(r => r.checked = false);
    };

    window.renderPoolList = () => {
        const lFilter = document.getElementById('list-l-filter').value;
        const list = db.pool.filter(q => lFilter === 'all' || q.l === lFilter);
        const container = document.getElementById('pool-list-container');
        
        if(list.length === 0) { container.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">Soru yok.</div>'; return; }

        container.innerHTML = list.slice().reverse().map(q => `
            <div class="q-card" id="q-card-${q.id}">
                <div class="q-header">
                    <span class="q-tag">${q.l} ${q.t ? '> '+q.t : ''}</span>
                    <button class="delete-btn" onclick="deleteQById(${q.id})" style="background:rgba(239,68,68,0.2); color:var(--danger); border:none; padding:5px 10px; border-radius:5px; font-weight:bold;">SİL</button>
                </div>
                <div class="q-body">
                    ${q.qImg ? `<div class="q-img-box"><img src="${q.qImg}" onclick="viewImg(this)"></div>` : ''}
                    ${q.qTxt ? `<div class="q-text">${q.qTxt}</div>` : ''}
                    
                    ${q.correct !== 'NONE' ? `
                    <div class="opt-group" id="opts-${q.id}">
                        <button class="opt-btn" onclick="checkAnswer(${q.id}, 'A', '${q.correct}')">A</button>
                        <button class="opt-btn" onclick="checkAnswer(${q.id}, 'B', '${q.correct}')">B</button>
                        <button class="opt-btn" onclick="checkAnswer(${q.id}, 'C', '${q.correct}')">C</button>
                        <button class="opt-btn" onclick="checkAnswer(${q.id}, 'D', '${q.correct}')">D</button>
                        <button class="opt-btn" onclick="checkAnswer(${q.id}, 'E', '${q.correct}')">E</button>
                    </div>` : ''}

                    <button class="q-reveal-btn" id="reveal-${q.id}" onclick="document.getElementById('ans-${q.id}').classList.add('visible'); this.style.display='none';">
                        ${q.correct !== 'NONE' ? 'Cevabı Göster' : 'Cevabı Göster (Şık Yok)'}
                    </button>
                    
                    <div class="q-answer-section" id="ans-${q.id}">
                        <div class="cahil-msg">"Cahil al sana cevap!"</div>
                        ${q.correct !== 'NONE' ? `<div class="q-answer-title">DOĞRU: ${q.correct}</div>` : ''}
                        ${q.aImg ? `<div class="q-img-box"><img src="${q.aImg}" onclick="viewImg(this)"></div>` : ''}
                        ${q.aTxt ? `<div class="q-text">${q.aTxt}</div>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    };
    
    window.checkAnswer = (id, selected, correct) => {
        const parent = document.getElementById(`opts-${id}`);
        const btns = parent.querySelectorAll('.opt-btn');
        btns.forEach(btn => {
            btn.disabled = true;
            if (btn.innerText === correct) btn.classList.add('correct');
            if (btn.innerText === selected && selected !== correct) btn.classList.add('wrong');
        });
        document.getElementById(`reveal-${id}`).click(); 
    };

    window.viewImg = (img) => { let w = window.open(""); w.document.write(`<img src="${img.src}" style="width:100%">`); };

    // GÜVENLİ SİLME
    window.deleteQById = (id) => {
        if(confirm('Bu soruyu silmek istediğinize emin misiniz?')) {
            const idx = db.pool.findIndex(q => q.id === id);
            if(idx > -1) {
                db.pool.splice(idx, 1);
                save();
                renderPoolList();
            }
        }
    };

    // --- DİĞER ---
    window.save = () => localStorage.setItem('kpss_pro_v30', JSON.stringify(db));
    window.clearData = () => { if(confirm('Her şeyi sil?')) { localStorage.removeItem('kpss_pro_v30'); location.reload(); } };
    window.exportData = () => { let a=document.createElement('a'); a.href='data:json;charset=utf-8,'+encodeURIComponent(JSON.stringify(db)); a.download='kpss_yedek.json'; a.click(); };
    window.triggerImport = () => document.getElementById('import-file').click();
    window.importData = (i) => { let r=new FileReader(); r.onload=e=>{db=JSON.parse(e.target.result); save(); location.reload();}; r.readAsText(i.files[0]); };

    window.toggleAcc = (el) => { let c=el.nextElementSibling; document.querySelectorAll('.accordion-content').forEach(x=>x!=c && x.classList.remove('open')); c.classList.toggle('open'); };
    window.toggleTop = (id,s,i,el) => { 
        if(db.topics[id]) delete db.topics[id]; else db.topics[id]=true; save(); 
        el.querySelector('input').checked=db.topics[id]; 
        // COĞRAFYA YÜZDE HESAPLAMA FIX
        let l=TOPICS[s].filter(t=>!t.trim().startsWith('-') && !t.trim().startsWith('—')).length;
        let d=TOPICS[s].filter(t=>(!t.trim().startsWith('-') && !t.trim().startsWith('—')) && db.topics[`${s}-${t}`]).length; 
        document.getElementById(`pct-${i}`).innerText=`%${Math.round((d/l)*100)}`; 
    };

    window.calcNet = (k,max,t) => { let d=Number(document.getElementById(`d-${k}`).value), y=Number(document.getElementById(`y-${k}`).value); if(d+y>max){alert('Hata!');t=='d'?document.getElementById(`d-${k}`).value='':document.getElementById(`y-${k}`).value='';}else{document.getElementById(`n-${k}`).innerText=(d-y*0.25).toFixed(2);}};
    window.saveExam = () => { let ex={id:Date.now(), name:document.getElementById('inp-name').value||'Deneme', date:document.getElementById('inp-date').value, res:{}, tot:0}; for(let L of LESSONS){ let d=Number(document.getElementById(`d-${L.k}`).value), y=Number(document.getElementById(`y-${L.k}`).value); if(d+y>L.q) return alert('Hata'); let n=d-y*0.25; ex.res[L.k]={d,y,n}; ex.tot+=n; } db.exams.push(ex); save(); alert('Kaydedildi!'); nav('history', document.getElementById('btn-hist')); };
    window.delExam=(id)=>{if(confirm('Sil?')){db.exams=db.exams.filter(e=>e.id!=id); save(); renderHistory(); renderHistoryChart();}};
    window.renderHistory = () => { document.getElementById('history-list').innerHTML = db.exams.slice().reverse().map(e => `<div class="history-card"><div class="h-header"><span class="h-date">${e.date}</span><button class="del-btn" onclick="delExam(${e.id})"><i class="fas fa-trash"></i></button></div><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><div class="h-title">${e.name}</div><div class="h-total">Top: ${e.tot.toFixed(2)}</div></div><div class="h-lessons-scroll">${LESSONS.map(l=>`<div class="h-lesson-box"><div class="hl-name">${l.l.substr(0,3)}</div><div class="hl-stat" style="color:#4ade80">D:${e.res[l.k].d}</div><div class="hl-stat" style="color:#f87171">Y:${e.res[l.k].y}</div><div class="hl-net">${e.res[l.k].n}</div></div>`).join('')}</div></div>`).join(''); };

    window.updateStats = () => {
        document.getElementById('d-total').innerText=db.exams.length; document.getElementById('d-pool').innerText=db.pool.length;
        document.getElementById('d-avg').innerText=db.exams.length?(db.exams.reduce((a,b)=>a+b.tot,0)/db.exams.length).toFixed(2):0;
        let t=0,d=0; 
        // COĞRAFYA GENEL YÜZDE HESAPLAMA FIX
        Object.keys(TOPICS).forEach(k=>{
            let l=TOPICS[k].filter(x=>!x.trim().startsWith('-') && !x.trim().startsWith('—')); 
            t+=l.length; 
            d+=l.filter(x=>db.topics[`${k}-${x}`]).length;
        }); 
        document.getElementById('d-prog').innerText=`%${t?Math.round((d/t)*100):0}`;
        renderCharts();
    };
    function renderCharts() {
        if(!db.exams.length) return;
        const ctxL=document.getElementById('lineChart'); if(chartInst.line) chartInst.line.destroy();
        const targetData = Array(db.exams.length).fill(db.config.target || 85);
        chartInst.line=new Chart(ctxL, { type:'line', data:{ labels:db.exams.map(e=>e.date.slice(5)), datasets:[{label:'Net', data:db.exams.map(e=>e.tot), borderColor:'#6366f1', tension:0.3}, {label:'Hedef', data:targetData, borderColor:'#ef4444', borderDash:[5,5], pointRadius:0, borderWidth:1}] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#333'}}}} });
        const ctxR=document.getElementById('radarChart'); if(chartInst.radar) chartInst.radar.destroy();
        chartInst.radar=new Chart(ctxR, { type:'radar', data:{labels:LESSONS.map(l=>l.l), datasets:[{label:'Başarı %', data:LESSONS.map(l=>(db.exams.reduce((a,b)=>a+b.res[l.k].n,0)/db.exams.length/l.q)*100), backgroundColor:'rgba(6,182,212,0.2)', borderColor:'#06b6d4'}]}, options:{responsive:true, maintainAspectRatio:false, scales:{r:{min:0, max:100, grid:{color:'#333'}, pointLabels:{color:'#eee', font:{size:10}}}}} });
    }
    function renderHistoryChart() {
        if(!db.exams.length) return;
        const ctx = document.getElementById('historyChart');
        const colors = ['#6366f1', '#06b6d4', '#f59e0b', '#22c55e', '#ef4444'];
        if(chartInst.history) chartInst.history.destroy();
        chartInst.history = new Chart(ctx, { type:'line', data:{ labels:db.exams.map(e=>e.name.substr(0,10)), datasets:LESSONS.map((l,i)=>({label:l.l, data:db.exams.map(e=>e.res[l.k].n), borderColor:colors[i], backgroundColor:colors[i], tension:0.3, borderWidth:2, pointRadius:2})) }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true, labels:{color:'#ddd', boxWidth:12, font:{size:10}}, onClick: function(e, legendItem, legend) { const index = legendItem.datasetIndex; const ci = legend.chart; let currentlySolo = true; for(let i=0; i<ci.data.datasets.length; i++) { if(i !== index && ci.isDatasetVisible(i)) { currentlySolo = false; break; } } if(currentlySolo && ci.isDatasetVisible(index)) { ci.data.datasets.forEach((ds, i) => { ci.setDatasetVisibility(i, true); }); } else { ci.data.datasets.forEach((ds, i) => { ci.setDatasetVisibility(i, i === index); }); } ci.update(); } }}, scales:{x:{display:false}, y:{grid:{color:'#333'}}}} });
    }
    
    window.updateExamSelection = () => { const val = document.getElementById('exam-selector').value; db.config.examDate = val; save(); updateCountdown(); };
    function updateCountdown() { 
        const dateStr = db.config.examDate;
        if (!dateStr) {
            document.getElementById('count-val').innerText = "-";
            document.getElementById('count-lbl').innerText = "Tarih Seçiniz";
            return;
        }
        const diffTime = new Date(dateStr) - new Date();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
             document.getElementById('count-val').innerText = "0";
             document.getElementById('count-lbl').innerText = "Sınav Geçti";
        } else {
             document.getElementById('count-val').innerText = diffDays;
             document.getElementById('count-lbl').innerText = "Gün Kaldı";
        }
    }
    window.setTargetNet = () => { let t=prompt("Hedef:", db.config.target||85); if(t){db.config.target=Number(t); save(); document.getElementById('target-lbl').innerHTML=`Hedef: ${t} <i class="fas fa-edit"></i>`; renderCharts();} };
</script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js").catch(console.error);
    });
  }
</script>
</body>
</html>