<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KPSS KoÃ§um Pro</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e2e">
    
    <!-- Cropper CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <!-- Chart.js & Cropper JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e2e;
            --primary: #6366f1;
            --secondary: #06b6d4;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #2d2d42;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: var(--bg-body); color: var(--text-main); 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            position: fixed; width: 100%;
        }

        /* TOAST BÄ°LDÄ°RÄ°MÄ° */
        #toast-container {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            z-index: 99999; pointer-events: none;
            display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 300px;
        }
        .toast {
            background: rgba(34, 197, 94, 0.95); color: white; padding: 12px 20px;
            border-radius: 8px; font-weight: 600; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0; transform: translateY(20px); transition: all 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* CROPPER MODAL */
        .cropper-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 99999;
            display: none; flex-direction: column;
        }
        .cropper-area { flex: 1; position: relative; overflow: hidden; background: #000; }
        .cropper-controls {
            height: 80px; background: #1e1e2e; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-top: 1px solid var(--border);
        }
        .crop-btn { padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; }
        .btn-cancel { background: #333; color: white; }
        .btn-confirm { background: var(--primary); color: white; }

        /* ALT MENÃœ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 12px 5px;
            z-index: 1000; padding-bottom: max(12px, env(safe-area-inset-bottom));
            overflow-x: auto;
        }
        .nav-btn { background: none; border: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; gap: 4px; cursor: pointer; flex: 1; }
        .nav-btn i { font-size: 1.3rem; margin-bottom: 2px; }
        .nav-btn.active { color: var(--primary); font-weight: bold; }

        /* ANA Ä°Ã‡ERÄ°K */
        .main-content { flex: 1; overflow-y: auto; padding: 15px 15px 90px 15px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        h2 { font-size: 1.3rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-top: 0; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* GERÄ° SAYIM KARTI */
        .countdown-card {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d42 100%);
            border: 1px solid var(--warning); border-radius: 12px;
            padding: 15px; margin-bottom: 20px; text-align: center; position: relative;
        }
        .count-days { font-size: 2.5rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-top: 40px; }
        .count-label { font-size: 0.9rem; color: var(--warning); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; font-weight: 600; }
        
        #exam-selector {
            position: absolute; top: 10px; right: 10px; left: 10px; width: calc(100% - 20px);
            background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            padding: 8px; border-radius: 8px; font-size: 0.9rem;
            outline: none; cursor: pointer; text-align: center;
            -webkit-appearance: none; appearance: none; font-weight: bold;
        }
        #exam-selector option { background: #1e1e2e; color: #fff; }

        /* GELÄ°ÅžTÄ°RÄ°CÄ° KARTI */
        .dev-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(6, 182, 212, 0.1) 100%);
            border: 1px solid var(--primary);
            border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
        }
        .app-title { font-size: 1.2rem; font-weight: 800; color: #fff; margin-bottom: 5px; letter-spacing: 1px; }
        .dev-name { font-size: 0.9rem; color: #a5b4fc; margin-bottom: 10px; }
        .contact-info { font-size: 0.8rem; color: #cbd5e1; display: flex; justify-content: center; gap: 15px; }
        .contact-info i { margin-right: 5px; }

        /* KARTLAR */
        .card { background: var(--bg-card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        
        /* DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .stat-box:active { transform: scale(0.96); background: rgba(255,255,255,0.06); }
        .stat-val { font-size: 1.4rem; font-weight: bold; margin-top: 5px; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

        /* FORM */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; background: #151520; border: 1px solid var(--border); color: white; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; }

        /* DERS SATIRLARI */
        .lesson-row { display: grid; grid-template-columns: 3fr 1fr 1fr 1.5fr; gap: 10px; align-items: center; background: rgba(255,255,255,0.02); padding: 12px; margin-bottom: 8px; border-radius: 8px; }
        .lesson-row div:first-child { font-size: 0.9rem; font-weight: 500; }
        .lesson-row input { text-align: center; padding: 8px 0; background: #111; border: 1px solid #333; }
        .net-badge { font-size: 0.9rem; color: var(--secondary); font-weight: bold; text-align: right; background: rgba(6, 182, 212, 0.1); padding: 5px; border-radius: 4px; }

        /* AKORDÄ°YON */
        .accordion { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; background: var(--bg-card); overflow: hidden; }
        .accordion-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); cursor: pointer; }
        .accordion-content { display: none; padding: 10px; border-top: 1px solid var(--border); background: #15151e; }
        .accordion-content.open { display: block; }
        .topic-item { display: flex; align-items: center; padding: 12px 5px; border-bottom: 1px solid #222; }
        .custom-cb { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--success); }
        .topic-name { flex: 1; font-size: 0.9rem; }
        .section-title { font-size: 0.75rem; color: var(--warning); margin: 15px 0 5px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* HAVUZ */
        .tab-menu { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-item { flex: 1; padding: 10px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; cursor: pointer; text-align: center; }
        .tab-item.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* RESÄ°M ALANLARI */
        .upload-area { border: 2px dashed var(--border); padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 15px; cursor: pointer; position: relative; }
        .upload-area p { margin: 5px 0 0 0; font-size: 0.8rem; color: var(--text-muted); }
        .upload-area.filled { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        .preview-thumb { max-height: 100px; margin-top: 10px; border-radius: 5px; display: none; }

        /* ÅžIK SEÃ‡Ä°MÄ° */
        .opt-group { display: flex; justify-content: center; gap: 5px; margin: 15px 0; flex-wrap: wrap; }
        .opt-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .opt-wide { width: auto; padding: 0 15px; border-radius: 20px; }
        .radio-label input { display: none; }
        .radio-label input:checked + .opt-btn { background: var(--success); border-color: var(--success); color: black; }
        
        /* SORU LÄ°STE Ã–ÄžESÄ° */
        .q-list-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .q-list-item:active { background: rgba(255,255,255,0.08); }
        .q-list-info b { color: var(--secondary); }
        .q-list-arrow { color: var(--text-muted); font-size: 1.2rem; }

        /* SORU GÃ–RÃœNTÃœLEME (GEZGÄ°N MODU) */
        #question-viewer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; 
            z-index: 10001; display: none; flex-direction: column; 
        }
        .qv-header { padding: 15px; background: #1e1e2e; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .qv-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .qv-body { flex: 1; overflow-y: auto; padding: 20px; text-align: center; position: relative; }
        
        .qv-nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: white;
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; backdrop-filter: blur(5px);
        }
        .qv-prev { left: 10px; }
        .qv-next { right: 10px; }

        .qv-content-box { max-width: 800px; margin: 0 auto; }
        .qv-img { max-width: 100%; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        .qv-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.6; }
        .qv-answer-area { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #444; display: none; animation: fadeIn 0.3s; }
        .qv-answer-area.show { display: block; }

        /* GEÃ‡MÄ°Åž GRID */
        .history-card { background: var(--bg-card); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .h-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .h-date { font-size: 0.85rem; color: var(--text-muted); font-family: monospace; }
        .h-title { font-weight: 700; color: #fff; font-size: 1rem; }
        .h-total { font-size: 1.2rem; color: var(--success); font-weight: 800; background: rgba(34, 197, 94, 0.1); padding: 2px 8px; border-radius: 5px; }
        .h-lessons-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .h-lesson-box { background: rgba(0,0,0,0.3); border-radius: 6px; padding: 6px 2px; display: flex; flex-direction: column; align-items: center; border-top: 3px solid #444; }
        .hl-tr { border-color: #3b82f6; } .hl-mat { border-color: #ef4444; } .hl-tar { border-color: #f59e0b; } .hl-cog { border-color: #10b981; } .hl-vat { border-color: #8b5cf6; }
        .hl-name { font-size: 0.7rem; font-weight: bold; color: #ccc; margin-bottom: 4px; text-transform: uppercase; }
        .hl-stat { font-size: 0.65rem; color: #999; line-height: 1.2; }
        .hl-net { font-size: 0.9rem; font-weight: 800; color: #fff; margin-top: 4px; }

        /* Veri YÃ¶netimi */
        .data-tools { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-data { flex: 1; padding: 10px; border-radius: 8px; font-size: 0.85rem; border: none; cursor: pointer; font-weight: bold; }
        .btn-backup { background: #151520; border: 1px solid var(--primary); color: var(--primary); }
        .btn-restore { background: #151520; border: 1px solid var(--secondary); color: var(--secondary); }
        .btn-reset { background: #151520; border: 1px solid var(--danger); color: var(--danger); }

        .hidden { display: none; }
        .canvas-box { height: 250px; margin-bottom: 20px; position: relative; }
        .history-chart-container { min-height: 300px; height: 300px; margin-bottom: 20px; width: 100%; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
</head>
<body>

    <!-- TOAST BÄ°LDÄ°RÄ°MÄ° -->
    <div id="toast-container"></div>

    <!-- CROPPER MODAL -->
    <div id="cropper-modal" class="cropper-modal-overlay">
        <div class="cropper-area">
            <img id="cropper-img" style="max-width:100%; max-height:80vh;">
        </div>
        <div class="cropper-controls">
            <button class="crop-btn btn-cancel" onclick="cancelCrop()">Ä°ptal</button>
            <button class="crop-btn btn-confirm" onclick="performCrop()">KÄ±rp & Kaydet</button>
        </div>
    </div>

    <!-- SORU GÃ–RÃœNTÃœLEYÄ°CÄ° (GEZGÄ°N MODU) -->
    <div id="question-viewer">
        <div class="qv-header">
            <div style="font-weight:bold;" id="qv-title">Soru DetayÄ±</div>
            <button class="qv-close" onclick="closeQuestionViewer()"><i class="fas fa-times"></i></button>
        </div>
        <div class="qv-body">
            <!-- SaÄŸ/Sol Oklar -->
            <button class="qv-nav-btn qv-prev" onclick="navigateQuestion(-1)"><i class="fas fa-chevron-left"></i></button>
            <button class="qv-nav-btn qv-next" onclick="navigateQuestion(1)"><i class="fas fa-chevron-right"></i></button>

            <div class="qv-content-box">
                <!-- SÄ°LME BUTONU -->
                <div style="text-align:right; margin-bottom:10px;">
                    <button onclick="deleteCurrentQ()" style="background:rgba(239,68,68,0.2); color:var(--danger); border:1px solid var(--danger); padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;"><i class="fas fa-trash"></i> SÄ°L</button>
                </div>

                <div id="qv-content">
                    <!-- Ä°Ã§erik JS ile dolacak -->
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        
        <!-- DASHBOARD -->
        <div id="page-dashboard">
            <div class="dev-card">
                <div class="app-title">KPSS Takip Pro</div>
                <div class="dev-name">GeliÅŸtirici: Cihan AkÄ±n</div>
                <div class="contact-info">
                    <span><i class="fas fa-envelope"></i> cihanakin72@outlook.com</span>
                    <span><i class="fab fa-instagram"></i> cihan.akin7</span>
                </div>
            </div>

            <div class="countdown-card">
                <select id="exam-selector" onchange="updateExamSelection()">
                    <option value="">Hedef SÄ±navÄ±nÄ± SeÃ§iniz</option>
                    <option value="2026-09-06">KPSS Lisans (06.09.2026)</option>
                    <option value="2026-10-04">KPSS Ã–nlisans (04.10.2026)</option>
                    <option value="2026-10-25">KPSS OrtaÃ¶ÄŸretim (25.10.2026)</option>
                </select>
                <div class="count-days" id="count-val">0</div>
                <div class="count-label" id="count-lbl">SÄ±nava Kalan GÃ¼n</div>
            </div>

            <h2>Genel Durum</h2>
            <div class="stats-grid">
                <div class="stat-box" onclick="nav('history', document.getElementById('btn-hist'))">
                    <div class="stat-val" id="d-total">0</div>
                    <div class="stat-label">Toplam Deneme</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" style="color:var(--secondary)" id="d-avg">0.0</div>
                    <div class="stat-label">Ortalama Net</div>
                </div>
                <div class="stat-box" onclick="nav('pool', document.getElementById('btn-pool'))">
                    <div class="stat-val" style="color:var(--warning)" id="d-pool">0</div>
                    <div class="stat-label">Soru Havuzuna Git</div>
                </div>
                <div class="stat-box" onclick="nav('topics', document.getElementById('btn-top'))">
                    <div class="stat-val" style="color:var(--primary)" id="d-prog">%0</div>
                    <div class="stat-label">Konu Bitirme</div>
                </div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; font-size:1rem; display:flex; justify-content:space-between;">
                    Net GidiÅŸatÄ±
                    <span id="target-lbl" onclick="setTargetNet()" style="font-size:0.8rem; color:var(--danger); cursor:pointer;">Hedef: 85 <i class="fas fa-edit"></i></span>
                </h3>
                <div class="canvas-box"><canvas id="lineChart"></canvas></div>
            </div>
        </div>

        <!-- DENEME EKLEME -->
        <div id="page-add" class="hidden">
            <h2>Deneme Ekle</h2>
            <div class="card">
                <div class="input-group">
                    <label>Deneme AdÄ±</label>
                    <input type="text" id="inp-name" placeholder="Ã–rn: Pegem TG-1">
                </div>
                <div class="input-group">
                    <label>Tarih</label>
                    <input type="date" id="inp-date">
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; padding:0 10px; font-size:0.8rem; color:#888; margin-bottom:5px;">
                <span style="flex:3">Ders</span><span style="flex:1; text-align:center">D</span><span style="flex:1; text-align:center">Y</span><span style="flex:1.5; text-align:right">Net</span>
            </div>
            <div id="lessons-container"></div>
            <button class="btn-primary" onclick="saveExam()">KAYDET</button>
        </div>

        <!-- SORU HAVUZU -->
        <div id="page-pool" class="hidden">
            <h2>Soru Havuzu</h2>
            <div class="tab-menu">
                <button class="tab-item active" onclick="poolTab('add')">Soru Ekle</button>
                <button class="tab-item" onclick="poolTab('list')">SorularÄ± GÃ¶r</button>
            </div>

            <!-- EKLEME -->
            <div id="pool-add-view">
                <div class="input-group"><select id="pool-lesson" onchange="loadPoolTopics()"></select></div>
                <div class="input-group"><select id="pool-topic"><option value="">Konu SeÃ§...</option></select></div>
                
                <!-- SORU -->
                <div class="card">
                    <h3 style="margin-top:0; font-size:0.9rem; color:var(--text-muted);">SORU</h3>
                    <div class="upload-area" onclick="triggerFile('file-q')" id="ua-q">
                        <i class="fas fa-camera"></i>
                        <p>Soru Resmi Ekle (KÄ±rpÄ±labilir)</p>
                        <input type="file" id="file-q" accept="image/*" hidden onchange="handleCropImage(this, 'poolQ')">
                        <img id="prev-q" class="preview-thumb">
                    </div>
                    <div class="input-group">
                        <textarea id="text-q" rows="3" placeholder="Veya buraya soruyu yaz..."></textarea>
                    </div>
                </div>

                <!-- DOÄžRU ÅžIK -->
                <div class="card" style="text-align:center;">
                    <h3 style="margin-top:0; font-size:0.9rem; color:var(--warning);">DOÄžRU ÅžIKKI SEÃ‡Ä°N</h3>
                    <div class="opt-group">
                        <label class="radio-label"><input type="radio" name="correct" value="A"><span class="opt-btn">A</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="B"><span class="opt-btn">B</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="C"><span class="opt-btn">C</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="D"><span class="opt-btn">D</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="E"><span class="opt-btn">E</span></label>
                        <label class="radio-label"><input type="radio" name="correct" value="NONE"><span class="opt-btn opt-wide">ÅžÄ±k Yok (Klasik)</span></label>
                    </div>
                </div>

                <!-- CEVAP -->
                <div class="card">
                    <h3 style="margin-top:0; font-size:0.9rem; color:var(--text-muted);">CEVAP / Ã‡Ã–ZÃœM DETAYI</h3>
                    <div class="upload-area" onclick="triggerFile('file-a')" id="ua-a">
                        <i class="fas fa-lightbulb"></i>
                        <p>Ã‡Ã¶zÃ¼m Resmi Ekle (KÄ±rpÄ±labilir)</p>
                        <input type="file" id="file-a" accept="image/*" hidden onchange="handleCropImage(this, 'poolA')">
                        <img id="prev-a" class="preview-thumb">
                    </div>
                    <div class="input-group">
                        <textarea id="text-a" rows="3" placeholder="Veya cevabÄ± buraya yaz..."></textarea>
                    </div>
                </div>

                <button class="btn-primary" onclick="addToPool()">HAVUZA KAYDET</button>
            </div>

            <!-- LÄ°STELEME (YENÄ°) -->
            <div id="pool-list-view" class="hidden">
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <select id="list-l-filter" onchange="renderPoolList()"><option value="all">TÃ¼m Dersler</option></select>
                    <select id="list-t-filter" onchange="renderPoolList()"><option value="all">TÃ¼m Konular</option></select>
                    <button onclick="openRandomQ()" style="padding:0 15px; background:var(--warning); color:black; border:none; border-radius:8px; font-weight:bold;">Rastgele</button>
                </div>
                <div id="pool-list-container"></div>
            </div>
        </div>

        <!-- KONU TAKÄ°BÄ° -->
        <div id="page-topics" class="hidden">
            <h2>Konu Takibi</h2>
            <div id="topics-list"></div>
        </div>

        <!-- GEÃ‡MÄ°Åž -->
        <div id="page-history" class="hidden">
            <h2>GeÃ§miÅŸ & Yedek</h2>
            <div class="data-tools">
                <button class="btn-data btn-backup" onclick="exportData()"><i class="fas fa-download"></i> Yedekle</button>
                <button class="btn-data btn-restore" onclick="triggerImport()"><i class="fas fa-upload"></i> YÃ¼kle</button>
                <button class="btn-data btn-reset" onclick="clearData()"><i class="fas fa-trash"></i> SÄ±fÄ±rla</button>
                <input type="file" id="import-file" accept=".json" hidden onchange="importData(this)">
            </div>
            <div class="card">
                <h3 style="margin-top:0; font-size:1rem;">Ders BazlÄ± GeliÅŸim</h3>
                <div class="history-chart-container"><canvas id="historyChart"></canvas></div>
            </div>
            <div id="history-list"></div>
        </div>

    </div>

    <!-- ALT MENÃœ (4 Buton) -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="nav('dashboard', this)"><i class="fas fa-chart-pie"></i><span>Ã–zet</span></button>
        <button class="nav-btn" onclick="nav('add', this)"><i class="fas fa-plus-circle"></i><span>Ekle</span></button>
        <button class="nav-btn" id="btn-pool" onclick="nav('pool', this)"><i class="fas fa-camera"></i><span>Havuz</span></button>
        <button class="nav-btn" id="btn-top" onclick="nav('topics', this)"><i class="fas fa-tasks"></i><span>Konu</span></button>
        <button class="nav-btn" id="btn-hist" onclick="nav('history', this)"><i class="fas fa-history"></i><span>GeÃ§miÅŸ</span></button>
    </div>

<script>
    // --- TOAST BÄ°LDÄ°RÄ°MÄ° ---
    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = msg;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    const LESSONS = [
        {k:'tr', l:'TÃ¼rkÃ§e', q:30, color:'hl-tr'}, 
        {k:'mat', l:'Matematik', q:30, color:'hl-mat'}, 
        {k:'tar', l:'Tarih', q:27, color:'hl-tar'}, 
        {k:'cog', l:'CoÄŸrafya', q:18, color:'hl-cog'}, 
        {k:'vat', l:'VatandaÅŸlÄ±k', q:15, color:'hl-vat'}
    ];
    const TOPICS = {
        'TÃ¼rkÃ§e': ['Ses Bilgisi', 'YazÄ±m KurallarÄ±', 'Noktalama Ä°ÅŸaretleri', 'SÃ¶zcÃ¼kte YapÄ±', 'CÃ¼mlenin Ã–geleri', 'AnlatÄ±m BozukluÄŸu', 'SÃ¶zel MantÄ±k', '--- SÃ–ZCÃœK TÃœRLERÄ° ---', '1-Ä°simler', '2-Tamlamalar', '3-Zamirler ( AdÄ±l )', '4-SÄ±fat (Ã–n ad)', '5-Zarf ( BelirteÃ§ )', '6-Edat / BaÄŸlaÃ§', 'SÃ–ZCÃœKTE ANLAM', '--- CÃœMLEDE ANLAM ---', '1-CÃ¼mle Tamamlama', '2-CÃ¼mle OluÅŸturma', '3-CÃ¼mle Yorumu', '4-CÃ¼mlelerin Anlam Ã–zelliÄŸi', '5-CÃ¼mlede Kesin YargÄ±', '6- CÃ¼mle BirleÅŸtirme', '--- PARAGRAFTA ANLAM ---', '1-AnlatÄ±m biÃ§imleri', '2-Konu baÅŸlÄ±k bulma', '3-Ana dÃ¼ÅŸÃ¼nce', '4-YardÄ±mcÄ± dÃ¼ÅŸÃ¼nce', '5-AkÄ±ÅŸÄ± bozan cÃ¼mle', '6-Tamamlama', '7-CÃ¼mle ekleme', '8-Ä°kiye bÃ¶lme', '9-Yer deÄŸiÅŸtirme', '10-Paragraf oluÅŸturma', '11-Ã‡oklu sorular'],
        'Matematik': ['Temel Kavramlar', 'SayÄ± BasamaklarÄ±', 'BÃ¶lme / BÃ¶lÃ¼nebilme', 'Rasyonel SayÄ±lar', 'EÅŸitsizlikler', 'Mutlak DeÄŸer', 'ÃœslÃ¼ SayÄ±lar', 'KÃ¶klÃ¼ SayÄ±lar', 'Ã‡arpanlara AyÄ±rma', 'Oran-OrantÄ±', 'KÃ¼meler', 'Ä°ÅŸlem ve ModÃ¼ler aritmetik', 'Fonksiyon', 'Per/Kom/OlasÄ±lÄ±k', 'SayÄ±sal MantÄ±k', '--- PROBLEMLER ---', 'SayÄ±', 'Kesir', 'YaÅŸ', 'Hareket', 'Ä°ÅŸÃ§i havuz', 'Kar-Zarar', 'KarÄ±ÅŸÄ±m', 'Grafik', '--- GEOMETRÄ° ---', 'ÃœÃ§genler', 'Ã‡okgenler / DÃ¶rtgenler', 'Ã‡ember ve Daire', 'Analitik Geometri', 'KatÄ± Cisimler'],
        'Tarih': ['Ä°slamiyet Ã–ncesi ilk T.T', 'Ä°lk TÃ¼rk-Ä°slam Devletleri', 'Anadolu SelÃ§uklu Devleti', '--- OSMANLI DEVLETÄ° ---', 'KÃ¼ltÃ¼r ve Medeniyeti', 'KuruluÅŸ DÃ¶nemi', 'YÃ¼kselme DÃ¶nemi', 'Duraklama DÃ¶nemi - XVII. yy', 'Gerileme DÃ¶nemi - XVIII. yy', 'DaÄŸÄ±lma DÃ¶nemi - XIX. yy', '--- Ä°NKLAP TARÄ°HÄ° ---', 'XX. YÃ¼zyÄ±lda OsmanlÄ± Devleti', 'KurtuluÅŸ SavaÅŸÄ± HazÄ±rlÄ±k DÃ¶nemi', 'I. TBMM DÃ¶nemi ve Ayaklanmalar', 'KurtuluÅŸ SavaÅŸÄ± DÃ¶nemi', 'AtatÃ¼rk\'Ã¼n HayatÄ±', 'AtatÃ¼rk DÃ¶nemi Ä°Ã§ Politika', 'AtatÃ¼rk Ä°lkeleri', 'AtatÃ¼rk Ä°nklaplarÄ±', 'AtatÃ¼rk DÃ¶nemi DÄ±ÅŸ Politika', '--- Ã‡AÄžDAÅž TÃœRK VE DÃœNYA TARÄ°HÄ° ---', 'XX. yy BaÅŸlarÄ±nda DÃ¼nya', 'II. DÃ¼nya SavaÅŸÄ±', 'SoÄŸuk SavaÅŸ DÃ¶nemi', 'YumuÅŸama DÃ¶nemi', 'KÃ¼reselleÅŸen DÃ¼nya'],
        'CoÄŸrafya': ['TÃ¼rkiye\'nin CoÄŸrafi Konumu', 'TÃ¼rkiye\'nin Ä°klimi', '--- TÃœRKÄ°YENÄ°N YER ÅžEKÄ°LLERÄ° ---', '1-DaÄŸlar', '2-Akarsular', '3-Platolar', '4-Ovalar', '5-GÃ¶lleri', '6-GÃ¶l ve BarajlarÄ±', '7-DoÄŸal Afetler', '8-Toprak OluÅŸumu ve Ã‡eÅŸitleri', '9-DÄ±ÅŸ Kuvvetler', '--- TÃœRKÄ°YE\'NÄ°N BEÅžERÄ° VE EKONOMÄ° COÄžRAFYASI ---', '1-NÃœFÃœS', '2-TARIM', '3-HAYVANCILIK', '4-MADENLER', '5-MADEN VE ENERJÄ° KAYNAKLARI', '6-SANAYÄ°', '7-ULAÅžIM', '8-TÄ°CARET', '9-TURÄ°ZM', '10-BÃ–LGESEL KALKINMA PROJELERÄ°'],
        'VatandaÅŸlÄ±k': ['Temel Hukuk KavramlarÄ±', 'Anayasa Tarihi', '1982 AnayasasÄ± Genel HÃ¼kÃ¼mler', 'Temel Hak ve HÃ¼rriyetler', 'Yasama', 'YÃ¼rÃ¼tme', 'YargÄ±', 'Ä°dare Hukuku', 'Ä°nsan HaklarÄ±']
    };

    let db = JSON.parse(localStorage.getItem('kpss_pro_v32')) || {exams:[], topics:{}, pool:[], config:{target:85, examDate:''}};
    let chartInst = {};
    let imgB64PoolQ = '', imgB64PoolA = '';
    let cropper = null;
    let currentCropTarget = '';
    let currentFilteredPool = [];
    let currentViewerIndex = 0;

    window.onload = () => { 
        document.getElementById('inp-date').valueAsDate = new Date(); 
        if(db.pool) db.pool.forEach(x => { if(!x.id) x.id = Date.now() + Math.random(); });
        save();
        initUI(); updateStats(); updateCountdown(); 
    };

    function initUI() {
        document.getElementById('lessons-container').innerHTML = LESSONS.map(L => `<div class="lesson-row"><div>${L.l}</div><input type="number" inputmode="numeric" id="d-${L.k}" placeholder="0" min="0" onblur="calcNet('${L.k}',${L.q}, 'd')"><input type="number" inputmode="numeric" id="y-${L.k}" placeholder="0" min="0" onblur="calcNet('${L.k}',${L.q}, 'y')"><div class="net-badge" id="n-${L.k}">0.0</div></div>`).join('');
        
        document.getElementById('topics-list').innerHTML = Object.keys(TOPICS).map((sub, i) => { 
            const list = TOPICS[sub], realT = list.filter(t => !t.trim().startsWith('-') && !t.trim().startsWith('â€”')), done = realT.filter(t => db.topics[`${sub}-${t}`]).length, pct = Math.round((done/realT.length)*100); 
            return `<div class="accordion"><div class="accordion-header" onclick="toggleAcc(this)"><div><strong>${sub}</strong></div><div id="pct-${i}" style="font-size:0.8rem; color:${pct===100?'var(--success)':'#aaa'}">%${pct}</div></div><div class="accordion-content">${list.map(t => (t.startsWith('---') || t.startsWith('â€”')) ? `<div class="section-title">${t.replace(/-/g,'').replace(/â€”/g,'')}</div>` : `<div class="topic-item" onclick="toggleTop('${sub}-${t}','${sub}',${i},this)"><input type="checkbox" class="custom-cb" ${db.topics[`${sub}-${t}`]?'checked':''}><span class="topic-name">${t}</span></div>`).join('')}</div></div>`; 
        }).join('');
        
        const opts = LESSONS.map(l=>`<option value="${l.l}">${l.l}</option>`).join('');
        const poolLessonSel = document.getElementById('pool-lesson');
        poolLessonSel.innerHTML += opts; poolLessonSel.value = "TÃ¼rkÃ§e"; loadPoolTopics();
        document.getElementById('list-l-filter').innerHTML += opts;
        
        if(db.config.examDate) {
            const sel = document.getElementById('exam-selector');
            if([...sel.options].some(o => o.value === db.config.examDate)) sel.value = db.config.examDate;
        }
        document.getElementById('target-lbl').innerHTML = `Hedef: ${db.config.target || 85} <i class="fas fa-edit"></i>`;
    }

    window.nav = (page, btn) => {
        document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`page-${page}`).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(page==='dashboard') updateStats();
        if(page==='history') { renderHistory(); renderHistoryChart(); }
        if(page==='pool') poolTab('list');
    };

    // --- HAVUZ VE CROPPER ---
    window.poolTab = (m) => { 
        document.querySelectorAll('#page-pool .hidden').forEach(e=>e.classList.add('hidden')); 
        document.getElementById(`pool-${m}-view`).classList.remove('hidden'); 
        if(m==='list') renderPoolList(); 
    };
    window.loadPoolTopics = () => { let l=document.getElementById('pool-lesson').value, s=document.getElementById('pool-topic'); s.innerHTML='<option value="">Konu SeÃ§...</option>'; if(TOPICS[l]) TOPICS[l].forEach(t=>{if(!t.startsWith('-') && !t.startsWith('â€”'))s.innerHTML+=`<option>${t}</option>`}); };
    
    window.triggerFile = (id) => document.getElementById(id).click();

    window.handleCropImage = (inp, targetVar) => {
        if (inp.files && inp.files[0]) {
            const file = inp.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('cropper-img');
                img.src = e.target.result;
                document.getElementById('cropper-modal').style.display = 'flex';
                currentCropTarget = targetVar;
                if (cropper) cropper.destroy();
                cropper = new Cropper(img, { viewMode: 1, autoCropArea: 1 });
                inp.value = ''; 
            };
            reader.readAsDataURL(file);
        }
    };

    window.cancelCrop = () => {
        document.getElementById('cropper-modal').style.display = 'none';
        if(cropper) cropper.destroy();
    };

    window.performCrop = () => {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({ maxWidth: 800 });
        const b64 = canvas.toDataURL('image/jpeg', 0.7);
        
        if (currentCropTarget === 'poolQ') {
            imgB64PoolQ = b64;
            document.getElementById('prev-q').src = b64;
            document.getElementById('prev-q').style.display = 'block';
            document.getElementById('ua-q').classList.add('filled');
        } else if (currentCropTarget === 'poolA') {
            imgB64PoolA = b64;
            document.getElementById('prev-a').src = b64;
            document.getElementById('prev-a').style.display = 'block';
            document.getElementById('ua-a').classList.add('filled');
        }
        cancelCrop();
    };

    window.addToPool = () => {
        let qTxt = document.getElementById('text-q').value;
        let aTxt = document.getElementById('text-a').value;
        let correctOpt = document.querySelector('input[name="correct"]:checked')?.value;
        
        if(!qTxt && !imgB64PoolQ) return alert('Soru iÃ§in en az bir resim veya yazÄ± girin.');
        if(!aTxt && !imgB64PoolA) return alert('Cevap/Ã‡Ã¶zÃ¼m iÃ§in en az bir resim veya yazÄ± girin.');
        if(!correctOpt) return alert('DoÄŸru ÅŸÄ±kkÄ± seÃ§melisiniz (ÅžÄ±k yoksa "ÅžÄ±k Yok"u seÃ§in).');

        db.pool.push({
            id: Date.now(),
            l: document.getElementById('pool-lesson').value,
            t: document.getElementById('pool-topic').value,
            qTxt: qTxt, qImg: imgB64PoolQ,
            aTxt: aTxt, aImg: imgB64PoolA,
            correct: correctOpt
        });
        save(); 
        showToast("âœ… Soru Havuza Eklendi!");
        
        // Reset
        imgB64PoolQ=''; imgB64PoolA='';
        document.getElementById('text-q').value=''; document.getElementById('text-a').value='';
        document.getElementById('prev-q').style.display='none'; document.getElementById('prev-a').style.display='none';
        document.getElementById('ua-q').classList.remove('filled'); document.getElementById('ua-a').classList.remove('filled');
        document.querySelectorAll('input[name="correct"]').forEach(r => r.checked = false);
    };

    // --- SORU GÃ–RÃœNTÃœLEME VE NAVÄ°GASYON ---
    window.renderPoolList = () => {
        const lFilter = document.getElementById('list-l-filter').value;
        const tFilter = document.getElementById('list-t-filter').value;
        
        currentFilteredPool = db.pool.filter(q => 
            (lFilter === 'all' || q.l === lFilter) &&
            (tFilter === 'all' || q.t === tFilter)
        ).reverse();

        const container = document.getElementById('pool-list-container');
        
        if(currentFilteredPool.length === 0) { container.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">Soru yok.</div>'; return; }

        container.innerHTML = currentFilteredPool.map((q, idx) => `
            <div class="q-list-item" onclick="openQuestionViewer(${idx})">
                <div class="q-list-info">
                    <b>${q.l}</b> ${q.t ? '> '+q.t : ''}
                </div>
                <i class="fas fa-chevron-right q-list-arrow"></i>
            </div>
        `).join('');
    };

    window.openQuestionViewer = (index) => {
        currentViewerIndex = index;
        document.getElementById('question-viewer').style.display = 'flex';
        renderQuestionInViewer();
    };
    
    window.openRandomQ = () => {
        if(currentFilteredPool.length === 0) return alert("Listede soru yok!");
        const randIdx = Math.floor(Math.random() * currentFilteredPool.length);
        openQuestionViewer(randIdx);
    };

    window.closeQuestionViewer = () => {
        document.getElementById('question-viewer').style.display = 'none';
    };

    window.navigateQuestion = (direction) => {
        const newIndex = currentViewerIndex + direction;
        if(newIndex >= 0 && newIndex < currentFilteredPool.length) {
            currentViewerIndex = newIndex;
            renderQuestionInViewer();
        }
    };

    function renderQuestionInViewer() {
        const q = currentFilteredPool[currentViewerIndex];
        const container = document.getElementById('qv-content');
        
        container.innerHTML = `
            <div style="text-align:center;">
                <div style="color:var(--secondary); font-weight:bold; margin-bottom:10px;">${q.l} ${q.t ? '> '+q.t : ''}</div>
                
                ${q.qImg ? `<img src="${q.qImg}" class="qv-img" onclick="viewImg(this)">` : ''}
                ${q.qTxt ? `<div class="qv-text">${q.qTxt}</div>` : ''}
                
                ${q.correct !== 'NONE' ? `
                <div class="opt-group" id="qv-opts">
                    <button class="opt-btn" onclick="checkViewerAnswer(this, 'A', '${q.correct}')">A</button>
                    <button class="opt-btn" onclick="checkViewerAnswer(this, 'B', '${q.correct}')">B</button>
                    <button class="opt-btn" onclick="checkViewerAnswer(this, 'C', '${q.correct}')">C</button>
                    <button class="opt-btn" onclick="checkViewerAnswer(this, 'D', '${q.correct}')">D</button>
                    <button class="opt-btn" onclick="checkViewerAnswer(this, 'E', '${q.correct}')">E</button>
                </div>` : ''}
                
                <button class="q-reveal-btn" onclick="document.getElementById('qv-ans').classList.add('show'); this.style.display='none';">CevabÄ± GÃ¶ster</button>
                
                <div id="qv-ans" class="qv-answer-area">
                    <div class="cahil-msg">"Cahil al sana cevap!"</div>
                    ${q.correct !== 'NONE' ? `<div class="q-answer-title">DOÄžRU: ${q.correct}</div>` : ''}
                    ${q.aImg ? `<img src="${q.aImg}" class="qv-img" onclick="viewImg(this)">` : ''}
                    ${q.aTxt ? `<div class="qv-text">${q.aTxt}</div>` : ''}
                </div>
            </div>
        `;
    }
    
    window.checkViewerAnswer = (btn, selected, correct) => {
        const parent = document.getElementById('qv-opts');
        const btns = parent.querySelectorAll('.opt-btn');
        btns.forEach(b => {
            b.disabled = true;
            if (b.innerText === correct) b.classList.add('correct');
            if (b.innerText === selected && selected !== correct) b.classList.add('wrong');
        });
    };
    
    window.deleteCurrentQ = () => {
        if(confirm('Bu soruyu silmek istediÄŸinize emin misiniz?')) {
            const q = currentFilteredPool[currentViewerIndex];
            const idx = db.pool.findIndex(item => item.id === q.id);
            if(idx > -1) {
                db.pool.splice(idx, 1);
                save();
                showToast("ðŸ—‘ï¸ Soru Silindi");
                closeQuestionViewer();
                renderPoolList();
            }
        }
    };

    window.viewImg = (img) => { let w = window.open(""); w.document.write(`<img src="${img.src}" style="width:100%">`); };

    // --- DÄ°ÄžER Ä°ÅžLEMLER ---
    window.save = () => localStorage.setItem('kpss_pro_v32', JSON.stringify(db));
    window.clearData = () => { if(confirm('Her ÅŸeyi sil?')) { localStorage.removeItem('kpss_pro_v32'); location.reload(); } };
    window.exportData = () => { let a=document.createElement('a'); a.href='data:json;charset=utf-8,'+encodeURIComponent(JSON.stringify(db)); a.download='kpss_yedek.json'; a.click(); };
    window.triggerImport = () => document.getElementById('import-file').click();
    window.importData = (i) => { let r=new FileReader(); r.onload=e=>{db=JSON.parse(e.target.result); save(); location.reload();}; r.readAsText(i.files[0]); };

    window.toggleAcc = (el) => { let c=el.nextElementSibling; document.querySelectorAll('.accordion-content').forEach(x=>x!=c && x.classList.remove('open')); c.classList.toggle('open'); };
    window.toggleTop = (id,s,i,el) => { 
        if(db.topics[id]) delete db.topics[id]; else db.topics[id]=true; save(); 
        el.querySelector('input').checked=db.topics[id]; 
        let l=TOPICS[s].filter(t=>!t.trim().startsWith('-') && !t.trim().startsWith('â€”')).length;
        let d=TOPICS[s].filter(t=>(!t.trim().startsWith('-') && !t.trim().startsWith('â€”')) && db.topics[`${s}-${t}`]).length; 
        document.getElementById(`pct-${i}`).innerText=`%${Math.round((d/l)*100)}`; 
    };

    window.calcNet = (k,max,t) => { let d=Number(document.getElementById(`d-${k}`).value), y=Number(document.getElementById(`y-${k}`).value); if(d+y>max){alert('Hata!');t=='d'?document.getElementById(`d-${k}`).value='':document.getElementById(`y-${k}`).value='';}else{document.getElementById(`n-${k}`).innerText=(d-y*0.25).toFixed(2);}};
    
    // DÄ°NAMÄ°K KAYIT VE TEMÄ°ZLEME
    window.saveExam = () => { 
        let ex={id:Date.now(), name:document.getElementById('inp-name').value||'Deneme', date:document.getElementById('inp-date').value, res:{}, tot:0}; 
        for(let L of LESSONS){ 
            let d=Number(document.getElementById(`d-${L.k}`).value), y=Number(document.getElementById(`y-${L.k}`).value); 
            if(d+y>L.q) return alert('Hata'); 
            let n=d-y*0.25; ex.res[L.k]={d,y,n}; ex.tot+=n; 
        } 
        db.exams.push(ex); 
        save(); 
        showToast("âœ… Deneme BaÅŸarÄ±yla Eklendi!");
        
        // FORM TEMÄ°ZLEME
        document.getElementById('inp-name').value = '';
        LESSONS.forEach(L => {
            document.getElementById(`d-${L.k}`).value = '';
            document.getElementById(`y-${L.k}`).value = '';
            document.getElementById(`n-${L.k}`).innerText = '0.0';
        });

        updateStats();
        renderHistory();
        renderHistoryChart();
        nav('history', document.getElementById('btn-hist'));
    };
    
    window.delExam=(id)=>{if(confirm('Sil?')){db.exams=db.exams.filter(e=>e.id!=id); save(); renderHistory(); renderHistoryChart();}};
    
    window.renderHistory = () => { 
        document.getElementById('history-list').innerHTML = db.exams.slice().reverse().map(e => `
        <div class="history-card">
            <div class="h-header">
                <span class="h-date">${e.date}</span>
                <button class="del-btn" onclick="delExam(${e.id})"><i class="fas fa-trash"></i></button>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <div class="h-title">${e.name}</div>
                <div class="h-total">Top: ${e.tot.toFixed(2)}</div>
            </div>
            <div class="h-lessons-grid">
                ${LESSONS.map(l=>`
                <div class="h-lesson-box ${l.color}">
                    <div class="hl-name">${l.l.substr(0,3)}</div>
                    <div class="hl-stat">D:${e.res[l.k].d}</div>
                    <div class="hl-stat">Y:${e.res[l.k].y}</div>
                    <div class="hl-net">${e.res[l.k].n}</div>
                </div>`).join('')}
            </div>
        </div>`).join(''); 
    };

    window.updateStats = () => {
        document.getElementById('d-total').innerText=db.exams.length; document.getElementById('d-pool').innerText=db.pool.length;
        document.getElementById('d-avg').innerText=db.exams.length?(db.exams.reduce((a,b)=>a+b.tot,0)/db.exams.length).toFixed(2):0;
        let t=0,d=0; 
        Object.keys(TOPICS).forEach(k=>{
            let l=TOPICS[k].filter(x=>!x.trim().startsWith('-') && !x.trim().startsWith('â€”')); 
            t+=l.length; 
            d+=l.filter(x=>db.topics[`${k}-${x}`]).length;
        }); 
        document.getElementById('d-prog').innerText=`%${t?Math.round((d/t)*100):0}`;
        renderCharts();
    };
    function renderCharts() {
        if(!db.exams.length) return;
        const ctxL=document.getElementById('lineChart'); if(chartInst.line) chartInst.line.destroy();
        const targetData = Array(db.exams.length).fill(db.config.target || 85);
        chartInst.line=new Chart(ctxL, { type:'line', data:{ labels:db.exams.map(e=>e.date.slice(5)), datasets:[{label:'Net', data:db.exams.map(e=>e.tot), borderColor:'#6366f1', tension:0.3}, {label:'Hedef', data:targetData, borderColor:'#ef4444', borderDash:[5,5], pointRadius:0, borderWidth:1}] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#333'}}}} });
        const ctxR=document.getElementById('radarChart'); if(chartInst.radar) chartInst.radar.destroy();
        chartInst.radar=new Chart(ctxR, { type:'radar', data:{labels:LESSONS.map(l=>l.l), datasets:[{label:'BaÅŸarÄ± %', data:LESSONS.map(l=>(db.exams.reduce((a,b)=>a+b.res[l.k].n,0)/db.exams.length/l.q)*100), backgroundColor:'rgba(6,182,212,0.2)', borderColor:'#06b6d4'}]}, options:{responsive:true, maintainAspectRatio:false, scales:{r:{min:0, max:100, grid:{color:'#333'}, pointLabels:{color:'#eee', font:{size:10}}}}} });
    }
    function renderHistoryChart() {
        if(!db.exams.length) return;
        const ctx = document.getElementById('historyChart');
        const colors = ['#6366f1', '#06b6d4', '#f59e0b', '#22c55e', '#ef4444'];
        if(chartInst.history) chartInst.history.destroy();
        chartInst.history = new Chart(ctx, { type:'line', data:{ labels:db.exams.map(e=>e.name.substr(0,10)), datasets:LESSONS.map((l,i)=>({label:l.l, data:db.exams.map(e=>e.res[l.k].n), borderColor:colors[i], backgroundColor:colors[i], tension:0.3, borderWidth:2, pointRadius:2})) }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true, labels:{color:'#ddd', boxWidth:12, font:{size:10}}, onClick: function(e, legendItem, legend) { const index = legendItem.datasetIndex; const ci = legend.chart; let currentlySolo = true; for(let i=0; i<ci.data.datasets.length; i++) { if(i !== index && ci.isDatasetVisible(i)) { currentlySolo = false; break; } } if(currentlySolo && ci.isDatasetVisible(index)) { ci.data.datasets.forEach((ds, i) => { ci.setDatasetVisibility(i, true); }); } else { ci.data.datasets.forEach((ds, i) => { ci.setDatasetVisibility(i, i === index); }); } ci.update(); } }}, scales:{x:{display:false}, y:{grid:{color:'#333'}}}} });
    }
    
    window.updateExamSelection = () => { const val = document.getElementById('exam-selector').value; db.config.examDate = val; save(); updateCountdown(); };
    function updateCountdown() { 
        const dateStr = db.config.examDate;
        if (!dateStr) {
            document.getElementById('count-val').innerText = "-";
            document.getElementById('count-lbl').innerText = "Tarih SeÃ§iniz";
            return;
        }
        const diffTime = new Date(dateStr) - new Date();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
             document.getElementById('count-val').innerText = "0";
             document.getElementById('count-lbl').innerText = "SÄ±nav GeÃ§ti";
        } else {
             document.getElementById('count-val').innerText = diffDays;
             document.getElementById('count-lbl').innerText = "GÃ¼n KaldÄ±";
        }
    }
    window.setTargetNet = () => { let t=prompt("Hedef:", db.config.target||85); if(t){db.config.target=Number(t); save(); document.getElementById('target-lbl').innerHTML=`Hedef: ${t} <i class="fas fa-edit"></i>`; renderCharts();} };
</script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js").catch(console.error);
    });
  }
</script>
</body>
</html>